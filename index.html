<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Balloon Inflator</title>

        <script type='module'>


async function DoGet(name)
{
    let urlMaker = new URL(`/get/${name}`, window.location);
    let url = urlMaker.href;
    // console.log(url);

    let json = await Fetch(url);

    return json;
}

async function DoSet(name, value)
{
    let urlMaker = new URL(`/set/${name}/${value}`, window.location);
    let url = urlMaker.href;
    // console.log(url);

    await Fetch(url);
}

async function Fetch(url)
{
    let retVal = null;

    try {
        let response = await fetch(url);

        if (response.ok)
        {
            let json = await response.json();

            retVal = json;
        }
        else
        {
            let err = await response.text();
            console.log("ERR: " + err);
        }
    } catch (e) {
        console.log("ERR: Exception: " + e);
    }

    return retVal;
}


function RegisterEvent(element, event, fn)
{
    element.addEventListener(event, e => {
        fn(e);
    });
    // element.dispatchEvent(new Event(event));
}

class App
{
    constructor()
    {
        this.domStatus = document.getElementById("status");
        this.domStart = document.getElementById("start");
        this.domStop = document.getElementById("stop");
        this.domPwm = document.getElementById("pwm");
        this.domPwmVal = document.getElementById("pwmVal");
        this.domPsiHigh = document.getElementById("psiHigh");
        this.domPsiHighVal = document.getElementById("psiHighVal");
        this.domPsiLow = document.getElementById("psiLow");
        this.domPsiLowVal = document.getElementById("psiLowVal");

        this.domStart.addEventListener("click", (e) => {
            DoSet("run", true);
        });
        this.domStop.addEventListener("click", (e) => {
            DoSet("run", false);
        });

        RegisterEvent(this.domPwm, "input", e => {
            DoSet("pwm", this.domPwm.value);
        });
        RegisterEvent(this.domPsiHigh, "input", e => {
            DoSet("psiHigh", this.domPsiHigh.value);
        });
        RegisterEvent(this.domPsiLow, "input", e => {
            DoSet("psiLow", this.domPsiLow.value);
        });

        // Set up polling
        setInterval(() => { this.OnTimeout() }, 1000);
        this.OnTimeout();
    }

    async OnTimeout()
    {
        let json = await DoGet("data");

        if (json != null)
        {
            this.domStatus.innerHTML = json.status;

            this.domPwm.value = parseInt(json.pwm);
            this.domPwmVal.value = this.domPwm.value

            this.domPsiHigh.value = parseFloat(json.psiHigh);
            this.domPsiHighVal.value = this.domPsiHigh.value

            this.domPsiLow.value = parseFloat(json.psiLow);
            this.domPsiLowVal.value = this.domPsiLow.value;
        }
        else
        {
            this.domStatus.innerHTML = "ERROR";
        }
    }
}

export let app = null;

window.addEventListener('DOMContentLoaded', (event) => {
    app = new App();
    window.app = app;
});

</script>

<style>

iframe {
    border: 1px solid black;
    width: 600px;
    height: 300px;
    resize: both;
    overflow: hidden;
}

table {
    border: 1px solid black;
    border-collapse: collapse;
}

th, td {
    border: 1px solid lightgrey;
    border-collapse: collapse;
}

th {
    min-width: 30px;
    background-color: lightblue;
    border: 1px solid black;
}

th, td {
    text-align: center;
    padding: 2px;
}

.headerRow {
    top: 0;
    position: sticky;
}


.right {
    float: right;
}



</style>

    </head>
    <body>
        Status: <span id="status"></span><br/>

        <button id="start">Start Inflation</button>
        <button id="stop">Stop Inflation</button>

        <table>
            <tr>
                <td>PWM</td>
                <td><input id="pwm" type="range" min="0" value="0" max="100" step="1" title="PWM" placeholder="PWM" oninput="pwmVal.value = this.value"></td>
                <td><output id="pwmVal">0</output></td>
            </tr>
            <tr>
                <td>PSI High</td>
                <td><input id="psiHigh" type="range" min="0" value="0.1" max="0.4" step="0.01" title="PSI High" placeholder="PSI High" oninput="psiHighVal.value = this.value"></td>
                <td><output id="psiHighVal">0.1</output></td>
            </tr>
            <tr>
                <td>PSI Low</td>
                <td><input id="psiLow" type="range" min="0" value="0.2" max="0.4" step="0.01" title="PSI Low" placeholder="PSI Low" oninput="psiLowVal.value = this.value"></td>
                <td><output id="psiLowVal">0.2</output></td>
            </tr>
        </table>
        
        
        <br/>


        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>

    </body>
</html>
