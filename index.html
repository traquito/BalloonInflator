<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Balloon Inflator</title>

        <script type='module'>

function GetDT()
{
    let dt = new Date();

    let YYYY = dt.getFullYear();
    let MM   = String((dt.getMonth() + 1)).padStart(2, '0')
    let DD   = String(dt.getDate()).padStart(2, '0')
    let hh   = String(dt.getHours()).padStart(2, '0')
    let mm   = String(dt.getMinutes()).padStart(2, '0')
    let ss   = String(dt.getSeconds()).padStart(2, '0')
    let ms   = String(dt.getMilliseconds()).padStart(3, '0')

    let dateTime = `${YYYY}-${MM}-${DD} ${hh}:${mm}:${ss}.${ms}`;

    return dateTime;
}

async function DoGet(name)
{
    let urlMaker = new URL(`/get/${name}`, window.location);
    let url = urlMaker.href;
    // console.log(url);

    let json = await Fetch(url);

    return json;
}

async function DoSet(name, value)
{
    let urlMaker = new URL(`/set/${name}/${value}`, window.location);
    let url = urlMaker.href;
    // console.log(url);

    await Fetch(url);
}

async function Fetch(url)
{
    let retVal = null;

    try {
        let response = await fetch(url);

        if (response.ok)
        {
            let json = await response.json();

            retVal = json;
        }
        else
        {
            let err = await response.text();
            console.log("ERR: " + err);
        }
    } catch (e) {
        console.log("ERR: Exception: " + e);
    }

    return retVal;
}


function RegisterEvent(element, event, fn)
{
    element.addEventListener(event, e => {
        fn(e);
    });
}

class App
{
    ResetData()
    {
        this.data = {
            psiMin: 0.0,
            psiMax: 0.4,

            psiSeries: {
                data: [
                ],
            },

            psiHighSeries: {
                data: [
                ],
            },

            psiLowSeries: {
                data: [
                ],
            },
            
            pwmMin:   0,
            pwmMax: 100,
            
            pwmSeries: {
                data: [
                ],
            },
        };
    }

    constructor()
    {
        this.ResetData();

        this.domSnapshotBaselinePsi = document.getElementById("snapshotBaselinePsi");
        this.domPsiBaseline = document.getElementById("psiBaseline");
        this.domPsiAbs = document.getElementById("psiAbs");
        this.domPsiRelative = document.getElementById("psiRelative");
        this.domStatus = document.getElementById("status");
        this.domStart = document.getElementById("start");
        this.domStop = document.getElementById("stop");
        this.domPause = document.getElementById("pause");
        this.domUnPause = document.getElementById("unpause");
        this.domReset = document.getElementById("reset");
        this.domStopGraph = document.getElementById("stopgraph");
        this.domStartGraph = document.getElementById("startgraph");
        this.domPsi = document.getElementById("psi");
        this.domPsiVal = document.getElementById("psiVal");
        this.domPwm = document.getElementById("pwm");
        this.domPwmVal = document.getElementById("pwmVal");
        this.domPsiHigh = document.getElementById("psiHigh");
        this.domPsiHighVal = document.getElementById("psiHighVal");
        this.domPsiLow = document.getElementById("psiLow");
        this.domPsiLowVal = document.getElementById("psiLowVal");

        this.domSnapshotBaselinePsi.addEventListener("click", (e) => {
            DoSet("snapshotPsiBaseline", this.domPsiAbs.innerHTML);
        });

        this.domStart.addEventListener("click", (e) => {
            DoSet("run", true);
        });
        this.domStop.addEventListener("click", (e) => {
            DoSet("run", false);
        });

        this.paused = false;
        this.stopped = false;
        this.domPause.addEventListener("click", (e) => {
            this.paused = true;
        });
        this.domUnPause.addEventListener("click", (e) => {
            this.paused = false;
        });
        this.domReset.addEventListener("click", (e) => {
            this.ResetData();
            this.OnTimeout();
        });
        this.domStopGraph.addEventListener("click", (e) => {
            this.stopped = true;
        });
        this.domStartGraph.addEventListener("click", (e) => {
            this.stopped = false;
        });

        RegisterEvent(this.domPsi, "input", e => {
            DoSet("psi", this.domPsi.value);
        });
        RegisterEvent(this.domPwm, "input", e => {
            DoSet("pwm", this.domPwm.value);
        });
        RegisterEvent(this.domPsiHigh, "input", e => {
            DoSet("psiHigh", this.domPsiHigh.value);
        });
        RegisterEvent(this.domPsiLow, "input", e => {
            DoSet("psiLow", this.domPsiLow.value);
        });

        this.graph = null;
        window.addEventListener("message", e => {
            this.graph = e.source;
        });


        // Set up polling
        setInterval(() => { this.OnTimeout() }, 200);
        this.OnTimeout();
    }

    async OnTimeout()
    {
        let json = await DoGet("data");

        if (json != null)
        {
            if (this.stopped == false)
            {
                // update graph data
                let dt = GetDT();
    
                this.data.psiSeries.data.push([dt, json.psi]);
                this.data.psiHighSeries.data.push([dt, json.psiHigh]);
                this.data.psiLowSeries.data.push([dt, json.psiLow]);
                this.data.pwmSeries.data.push([dt, json.pwmUsed]);
    
                if (this.graph && this.paused == false)
                {
                    this.graph.postMessage({
                        type: "REP_DATA",
                        data: this.data,
                    }, "*");
                }
            }

            // update visual elements
            this.domStatus.innerHTML = json.status;
            if (json.status == "running")
            {
                this.domStatus.style.backgroundColor = "lightgreen";
            }
            else if (json.status == "stopped")
            {
                this.domStatus.style.backgroundColor = "pink";

                this.domStatus.innerHTML += ` (${json.stopReason})`;
            }

            this.domPsiAbs.innerHTML = parseFloat(json.psiAbs).toFixed(2);
            this.domPsiBaseline.innerHTML = parseFloat(json.psiBaseline).toFixed(2);
            this.domPsiRelative.innerHTML = parseFloat(json.psi).toFixed(2);

            this.domPsi.value = parseFloat(json.psi);
            this.domPsiVal.value = this.domPsi.value

            this.domPwm.value = parseInt(json.pwm);
            this.domPwmVal.value = this.domPwm.value

            this.domPsiHigh.value = parseFloat(json.psiHigh);
            this.domPsiHighVal.value = this.domPsiHigh.value

            this.domPsiLow.value = parseFloat(json.psiLow);
            this.domPsiLowVal.value = this.domPsiLow.value;
        }
        else
        {
            this.domStatus.innerHTML = "ERROR";
            this.domStatus.style.backgroundColor = "red";
        }
    }
}

export let app = null;

window.addEventListener('DOMContentLoaded', (event) => {
    app = new App();
    window.app = app;
});

</script>

<style>

iframe {
    border: 1px solid black;
    width: 900px;
    height: 400px;
    resize: both;
    overflow: hidden;
}

table {
    border: 1px solid black;
    border-collapse: collapse;
}

th, td {
    border: 1px solid lightgrey;
    border-collapse: collapse;
}

th {
    min-width: 30px;
    background-color: lightblue;
    border: 1px solid black;
}

th, td {
    text-align: center;
    padding: 2px;
}

.headerRow {
    top: 0;
    position: sticky;
}


.right {
    float: right;
}

.debug {
    display: none;
}

</style>

    </head>
    <body>
        <table>
            <tr>
                <td>PSI Now</td>
                <td><span id="psiAbs">14.52</span></td>
            </tr>
            <tr>
                <td>PSI Baseline</td>
                <td><span id="psiBaseline">14.52</span></td>
            </tr>
            <tr>
                <td>PSI Relative</td>
                <td><span id="psiRelative">0.00</span></td>
            </tr>
        </table>
        <button id="snapshotBaselinePsi">Snapshot Baseline</button>

        <br/>
        <br/>

        Status: <span id="status"></span><br/>

        <button id="start">Start Inflation</button>
        <button id="stop">Stop Inflation</button>

        <br/>
        <br/>

        </iframe><iframe id="graph" scrolling="no" src="ChartTimeSeries.html"></iframe>

        <br/>

        <button id="pause">Pause Graph</button>
        <button id="unpause">Un-Pause Graph</button>
        <button id="reset">Reset Graph</button>
        <button id="stopgraph">Stop Graph</button>
        <button id="startgraph">Start Graph</button>

        <br/>
        <br/>

        <table>
            <tr class="debug">
                <td>PSI (debug)</td>
                <td><input id="psi" type="range" min="0" value="0" max="0.4" step="0.01" title="PSI" placeholder="PSI" oninput="psiVal.value = this.value"></td>
                <td><output id="psiVal">0</output></td>
            </tr>
            <tr>
                <td>PWM</td>
                <td><input id="pwm" type="range" min="0" value="80" max="100" step="1" title="PWM" placeholder="PWM" oninput="pwmVal.value = this.value"></td>
                <td><output id="pwmVal">80</output></td>
            </tr>
            <tr>
                <td>PSI High</td>
                <td><input id="psiHigh" type="range" min="0" value="0.1" max="0.4" step="0.01" title="PSI High" placeholder="PSI High" oninput="psiHighVal.value = this.value"></td>
                <td><output id="psiHighVal">0.1</output></td>
            </tr>
            <tr>
                <td>PSI Low</td>
                <td><input id="psiLow" type="range" min="0" value="0.2" max="0.4" step="0.01" title="PSI Low" placeholder="PSI Low" oninput="psiLowVal.value = this.value"></td>
                <td><output id="psiLowVal">0.2</output></td>
            </tr>
        </table>
        
        
        <br/>


        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>

    </body>
</html>
